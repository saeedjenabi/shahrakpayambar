<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ورود ساکنین | مجتمع مسکونی پیامبر</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap');
  body {
    font-family: 'Vazirmatn', Tahoma, sans-serif;
    direction: rtl;
    margin: 0;
    background-color: #f4f6f8;
    color: #333;
  }
  header {
    background: #2c3e50;
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.8rem;
  }
  nav {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
 nav a {
    color: white;
    text-decoration: none;
    padding: 8px 15px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
    font-weight: 600;
  }
  nav a:hover {
    background-color: #27ae60;
  }
  main {
    max-width: 400px;
    margin: 3rem auto 5rem;
    background: white;
    padding: 2.5rem 2.5rem 3rem;
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
    color: #27ae60;
    margin-bottom: 2rem;
    font-size: 2rem;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 1.3rem;
  }
  label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: #2c3e50;
  }
  input[type="text"],
  input[type="password"] {
    padding: 0.65rem 1rem;
    font-size: 1rem;
    border: 2px solid #bdc3c7;
    border-radius: 8px;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus,
  input[type="password"]:focus {
    outline: none;
    border-color: #27ae60;
  }
  button {
    margin-top: 1.8rem;
    padding: 0.9rem 0;
    font-size: 1.2rem;
    font-weight: 700;
    color: white;
    background-color: #27ae60;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover, button:focus {
    background-color: #219150;
  }
  footer {
    background: #34495e;
    color: #ecf0f1;
    text-align: center;
    padding: 2.5rem 1rem;
    margin-top: 6rem;
  }
  footer .footer-links {
    margin-bottom: 1.5rem;
  }
  footer .footer-links a {
    color: #ecf0f1;
    text-decoration: none;
    margin: 0 12px;
    font-weight: 600;
    transition: color 0.3s ease;
  }
  footer .footer-links a:hover {
    color: #27ae60;
  }
  footer p {
    margin: 0.6rem 0;
    font-size: 0.95rem;
  }
  footer .social-icons a {
    color: #27ae60;
    margin: 0 12px;
    font-size: 1.6rem;
    text-decoration: none;
    transition: color 0.3s ease;
  }
  footer .social-icons a:hover {
    color: #1e8449;
  }
  @media (max-width: 440px) {
    main {
      margin: 2rem 1rem 4rem;
      padding: 2rem 1.5rem 2.5rem;
      max-width: 95%;
    }
  }
</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>
<body>

<header>
  <h1>مجتمع مسکونی پیامبر</h1>
  <nav>
    <a href="index.html">خانه</a>
    <a href="news.html">اخبار</a>
	<a href="amenities.html">امکانات</a>
	<a href="asasnameh.html">اساسنامه</a>
    <a href="payment.html">پرداخت شارژ</a>
    <a href="request.html">ثبت درخواست</a>
	<a href="contact.html">پیام به مدیریت</a>
  </nav>
</header>

<main>
  <h2>ورود ساکنین</h2>
  <form action="#" method="post">
    <label for="username">نام کاربری</label>
    <input type="text" id="username" name="username" placeholder="شماره موبایل مالک بدون صفر را وارد نمایید" required />

    <label for="password">رمز عبور</label>
    <input type="password" id="password" name="password" placeholder="رمز عبور خود را وارد کنید" required />

    <button type="submit">ورود</button>
  </form>
</main>

<footer>
  <div class="footer-links" style="margin-bottom:1.5rem;">
    <a href="index.html">خانه</a> |
    <a href="amenities.html">امکانات</a> |
    <a href="payment.html">پرداخت شارژ</a> |
    <a href="contact.html">تماس با مدیریت</a> |
    <a href="asasnameh.html">اساسنامه</a> |
    <a href="login.html">ورود ساکنین</a> |
    <a href="request.html">ثبت درخواست</a>
  </div>
  <p>مجتمع مسکونی پیامبر © 2025. تمامی حقوق محفوظ است.</p>
  <p>تهران، اتوبان حکیم، غرب خیابان پیامبر مرکزی، روبروی مسجد پیامبر</p>
  <p>تلفن تماس: ۰۲۱-۱۲۳۴۵۶۷۸</p>
  <div class="social-icons" style="margin-top:1rem;">
    <a href="#" aria-label="تلگرام"><i class="fab fa-telegram fa-lg"></i></a>
    <a href="#" aria-label="اینستاگرام"><i class="fab fa-instagram fa-lg"></i></a>
    <a href="#" aria-label="واتساپ"><i class="fab fa-whatsapp fa-lg"></i></a>
  </div>
</footer>


<!-- ===== Inline modal (hidden) + minimal styles, no change to existing layout ===== -->
<style>
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal{background:#fff;width:min(92vw,520px);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
  .modal-header{background:#27ae60;color:#fff;padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between}
  .modal-header h3{margin:0;font-size:1.1rem}
  .modal-close{background:transparent;border:0;color:#fff;font-size:1.2rem;cursor:pointer}
  .modal-body{padding:1.1rem 1.25rem 1.3rem;line-height:1.9;color:#2c3e50}
  .spinner{display:inline-block;width:1.05rem;height:1.05rem;border:3px solid #e5e7eb;border-top-color:#fff;border-right-color:#fff;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .stack{display:grid;gap:.5rem}
</style>
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">وضعیت</h3>
      <button class="modal-close" aria-label="بستن" onclick="document.getElementById('modalBackdrop').style.display='none'">×</button>
    </div>
    <div class="modal-body">
      <div id="modalMessage"><span class="spinner"></span> لطفاً منتظر بمانید…</div>
      <div id="modalDetails" class="stack"></div>
    </div>
  </div>
</div>

<!-- SheetJS for reading XLSX in-browser -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(function(){
  let DB = [];
  let usernameKey = null, passwordKey = null;

  function openModal(msg, details){
    document.getElementById('modalMessage').innerHTML = msg || '';
    document.getElementById('modalDetails').innerHTML = details || '';
    document.getElementById('modalBackdrop').style.display = 'flex';
  }
  function updateModal(msg, details){
    if (msg !== undefined) document.getElementById('modalMessage').innerHTML = msg;
    if (details !== undefined) document.getElementById('modalDetails').innerHTML = details;
  }

  function inferKeys(sample){
    const keys = Object.keys(sample||{});
    const userCands = ['username','user','نام_کاربری','شماره_واحد','unit','unit_number','unitnumber','واحد'];
    const passCands = ['password','pass','رمز','رمز_عبور','پسورد'];
    function pick(cands){
      for(const c of cands){ if(keys.includes(c)) return c; }
      for(const k of keys){ const kk = String(k).toLowerCase(); if(cands.some(c=>kk.includes(c))) return k; }
      return null;
    }
    usernameKey = pick(userCands) || keys[0];
    passwordKey = pick(passCands);
  }

  async function loadXLSX(){
    const res = await fetch('site-db.xlsx', {cache:'no-store'});
    if(!res.ok) throw new Error('خطا در خواندن فایل اکسل');
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {defval:''});
    DB = rows;
    if(DB.length) inferKeys(DB[0]);
  }

  // Bind to existing form without changing markup
  window.addEventListener('DOMContentLoaded', function(){
    const form = document.querySelector('main form');
    if(!form) return;
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      openModal('<span class="spinner"></span> لطفاً منتظر بمانید…', 'در حال بررسی اطلاعات ورود');

      try{
        if(!DB.length) await loadXLSX();
        const username = (document.getElementById('username')||{}).value?.trim() || '';
        const password = (document.getElementById('password')||{}).value?.trim() || '';

        const rec = DB.find(row=>{
          const u = String(row[usernameKey] ?? '').trim();
          const p = passwordKey ? String(row[passwordKey] ?? '').trim() : '';
          return (u === username) && (!passwordKey || p === password);
        });

        if(rec){
          // Build details list (exclude password field)
          const list = Object.entries(rec).filter(([k])=>k !== passwordKey).map(([k,v])=>{
            const safeV = String(v ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            return `<div><strong>${String(k).replace(/_/g,' ')}</strong>: ${safeV}</div>`;
          }).join('');
          updateModal('ورود با موفقیت انجام شد ✅',list);
        } else {
          updateModal('نام کاربری یا رمز عبور نادرست است. ❌', '');
        }
      }catch(err){
        updateModal('امکان دسترسی به دیتا بیس در حال حاضر مقدور نیست  ❌');
      }
    });
  });
})();
</script>


<!-- Injected iframe-transport login (CORS-free) -->
<script>
(function(){
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzGSKWbMFMOhEPrvSdbZXrZNxI1mOmW73qOZc8US9uixxkuEE_UOClQMWcoX1Ttve8aVw/exec';

  function getEl(id){ return document.getElementById(id); }
  function show(msg, details){
    const b = getEl('modalBackdrop'), m = getEl('modalMessage'), d = getEl('modalDetails');
    if (b && m){ m.innerHTML = msg || ''; if (d) d.innerHTML = details || ''; b.style.display = 'flex'; }
    else { alert((msg||'') + (details? ('\n'+details):'')); }
  }
  function update(msg, details){
    const m = getEl('modalMessage'), d = getEl('modalDetails');
    if (m && msg !== undefined) m.innerHTML = msg;
    if (d && details !== undefined) d.innerHTML = details;
  }
  function sanitize(v){ return String(v ?? '').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Create a hidden iframe target for classic form POST that can reply via postMessage.
  function ensureIframe(){
    let ifr = document.getElementById('as_iframe_transport');
    if (!ifr){
      ifr = document.createElement('iframe');
      ifr.name = 'as_iframe_transport';
      ifr.id = 'as_iframe_transport';
      ifr.style.display = 'none';
      document.body.appendChild(ifr);
    }
    return ifr;
  }

  // Listen for responses from Apps Script (HtmlService) via postMessage
  window.addEventListener('message', function(ev){
    try{
      const data = typeof ev.data === 'string' ? JSON.parse(ev.data) : ev.data;
      if (!data || !data.__as_bridge) return;
      if (data.ok){
        const list = Object.entries(data.profile || {}).map(([k,v])=>{
          return `<div><strong>${sanitize(k.replace(/_/g,' '))}</strong>: ${sanitize(v)}</div>`;
        }).join('');
        update('ورود با موفقیت انجام شد ✅', list || '');
      } else {
        update('نام کاربری یا رمز عبور نادرست است. ❌', '');
      }
    }catch(_){}
  });

  window.addEventListener('DOMContentLoaded', function(){
    const form = document.querySelector('form') || document.getElementById('loginForm') || document.querySelector('main form');
    if (!form) return;
    ensureIframe();

    form.addEventListener('submit', function(e){
      e.preventDefault();
      const username = (document.getElementById('username')||{}).value?.trim() || '';
      const password = (document.getElementById('password')||{}).value?.trim() || '';

      show('<span class="spinner"></span> لطفاً منتظر بمانید…', 'در حال بررسی اطلاعات ورود');

      // Build a one-off classic form to post to the iframe target
      const f = document.createElement('form');
      f.action = ENDPOINT;
      f.method = 'POST';
      f.target = 'as_iframe_transport';

      const u = document.createElement('input'); u.name = 'username'; u.value = username;
      const p = document.createElement('input'); p.name = 'password'; p.value = password;
      const t = document.createElement('input'); t.name = '_transport'; t.value = 'iframe';
      f.appendChild(u); f.appendChild(p); f.appendChild(t);

      document.body.appendChild(f);
      f.submit();
      setTimeout(()=>{ f.remove(); }, 500);
    }, true);
  });
})();
</script>
</body>
</html>
